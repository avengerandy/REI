<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>REI MVP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }
        .list-group-item {
            background-color: #1e1e1e;
            color: #ffffff;
            cursor: pointer;
        }
        .list-group-item:hover {
            background-color: #2c2c2c;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-6">
                <h4>推薦清單</h4>
                <ul id="rec-list" class="list-group"></ul>
            </div>
            <div class="col-md-6">
                <h4>點擊紀錄</h4>
                <ul id="clicked-list" class="list-group"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.5.0';
        env.allowLocalModels = false;

        class EmbeddingProcessor {
            constructor() {
                this.pipeline = null;
            }

            async init() {
                this.pipeline = await pipeline(
                    'feature-extraction',
                    'Xenova/paraphrase-multilingual-MiniLM-L12-v2',
                    {dtype: "q8"}
                );
            }

            async embed(texts) {
                const output = await this.pipeline(texts, {
                    pooling: 'mean',
                    normalize: false
                });

                return output.sigmoid().tolist();
            }
        }

        class UserProfile {
            constructor(dim = 384) {
                this.count = 0;
                this.sum = new Array(dim).fill(0);
            }

            update(embedding) {
                this.count += 1;
                for (let i = 0; i < this.sum.length; i++) {
                    this.sum[i] += embedding[i];
                }
            }

            getBetaScores(vec) {
                const scores = [];
                for (let i = 0; i < vec.length; i++) {
                    const a = this.sum[i] + 1;
                    const b = this.count - this.sum[i] + 1;
                    const x = vec[i];
                    scores.push(betaPDF(x, a, b));
                }
                return scores;
            }
        }

        class Ranker {
            static rank(items, profile) {
                return items.map(item => {
                    const scores = profile.getBetaScores(item.embedding);
                    const score = scores.reduce((a, b) => a + b, 0) / scores.length;
                    return { ...item, score };
                }).sort((a, b) => b.score - a.score);
            }
        }

        function betaPDF(x, a, b) {
            if (x <= 0 || x >= 1) {
                return 0;
            }
            const gamma = n => {
                const g = 7;
                const p = [
                    0.99999999999980993,
                    676.5203681218851,
                    -1259.1392167224028,
                    771.32342877765313,
                    -176.61502916214059,
                    12.507343278686905,
                    -0.13857109526572012,
                    9.9843695780195716e-6,
                    1.5056327351493116e-7
                ];
                if (n < 0.5) {
                    return Math.PI / (Math.sin(Math.PI * n) * gamma(1 - n));
                }
                n -= 1;
                let x = p[0];
                for (let i = 1; i < g + 2; i++) {
                    x += p[i] / (n + i);
                }
                const t = n + g + 0.5;
                return Math.sqrt(2 * Math.PI) * Math.pow(t, n + 0.5) * Math.exp(-t) * x;
            };
            const B = (a, b) => gamma(a) * gamma(b) / gamma(a + b);
            return (Math.pow(x, a - 1) * Math.pow(1 - x, b - 1)) / B(a, b);
        }

        window.onload = async () => {
            const processor = new EmbeddingProcessor();
            await processor.init();

            const profile = new UserProfile();

            const embeddings = await processor.embed(recallData);

            let items = recallData.map((title, i) => ({
                id: `item_${i}`,
                title,
                embedding: embeddings[i]
            }));

            let clicked = [];

            const recList = document.getElementById("rec-list");
            const clickedList = document.getElementById("clicked-list");

            const render = () => {
                recList.innerHTML = "";
                clickedList.innerHTML = "";

                const ranked = Ranker.rank(items, profile);

                for (const item of ranked) {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = item.title;
                    li.onclick = () => {
                        profile.update(item.embedding);
                        clicked.push(item);
                        items = items.filter(x => x.id !== item.id);
                        render();
                    };
                    recList.appendChild(li);
                }

                for (const item of clicked) {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = item.title;
                    clickedList.appendChild(li);
                }
            };

            render();
        };

        var recallData = [
            "認真，就不輸了：不焦慮的成長型教養筆記【限量親簽+贈品版】",
            "十誡【作家親簽版】（繼續橫掃日本推理文壇，《方舟》作家最新作品，變態凶手讓全員變共犯！）",
            "【4/23預購】特別MEZASTAR卡匣造型悠遊卡 (5/9起陸續出貨)【受託代銷】",
            "再見，爆米花（首刷附贈限量「爆米花紀念透卡」）",
            "在文庫旅館等待的書【作家親簽版】（《星期五的書店》作家連繫人與書本的溫柔新作）",
            "鵼之碑（京極夏彥出道30週年紀念作，創作生涯代表作「百鬼夜行」系列最新作，石黑亞矢子繪製獨家限量書衣）",
            "我們都是孩子的引導師：ADHD也是一種天賦，每個生命都有獨特的魔法，值得被溫柔點亮",
            "供應鏈之死與 PI 的崛起：實體 AI 如何革命性的推動下一個時代智慧物流暨供應鏈管理、改變我們賺錢的方式",
            "與人為善的幸福哲學：吳家德的豐盛人生心法",
            "英文時事閱讀選2025版（附QR Code 線上音檔） (電子書)",
            "職業棒球 5月號/2025 第518期",
            "(電子票) 限時特價↘統一集團通用 1000元 7-ELEVEN數位商品禮券 喜客券【受託代銷】",
            "極限銷售（親簽版）：4招贏得信任，不要想著賣東西，就能締造無限商機",
            "悠哉悠哉昆蟲圖鑑",
            "陪孩子好好說話：讓愛無礙，養成良好的親子溝通",
            "認知破局【限量博客來獨家書衣＋2025破局曆】：解題思路比答案本身重要一萬倍",
            "2024年第3屆世界12強棒球錦標賽奪冠紀念悠遊卡【受託代銷】",
            "你的信任，是孩子最強大的底氣：神老師的客製化教養，打造「以孩子為中心」的正向思維！【親筆簽名版】",
            "spring【限量親簽版．故事之神恩田陸十年大作】",
            "【MUJI 無印良品】男棉混腳跟防磨淺口直角襪25-27cm 柔白",
            "【Earth地球製藥】馬桶發泡清潔粉 180g",
            "變色龍依戀掌心 2 (首刷限定版)",
            "臺灣政治有意思！若林正丈的臺灣民主化現場【作者限量簽名版】",
            "如何找到你真正想做的事：AI世代生涯探索行動指南（首刷限量金句書籤贈品版）",
            "完全版 SHAKARIKI 鐵馬頑童 7 書盒版",
            "平凡職業造就世界最強 14 (首刷限定版)",
            "阿甘節稅法：全方位理財第三堂課，讓你隱形加薪，退休金翻倍",
            "追求極限記憶，只要在學習中加一點「想像力」：手腦並用×諧音串聯×分段簡化×自我測驗，將龐大資訊化繁為簡，快速掌握關鍵資訊 (電子書)",
            "賈伯斯的叛逆哲學，62條離經叛道的成功祕訣：保持好奇×勇敢拒絕×海盜精神……看賈伯斯的設計哲學、商業戰略與顛覆性思維，谷底翻身創造商業神話！ (電子書)",
            "【魚池鄉農會】初見系列_紅茶(2公克x20包/盒)x2盒組；任選",
            "【汪喵星球】點心罐- 雞丁+南瓜80g",
            "【汪喵星球】點心罐- 雞絲80g",
            "【Missking 1983】東大門小花隱形襪船襪 (5雙組)",
            "走人少的路：連加恩的非典型旅程【作者親簽】",
            "續・被狡猾的男人撿回家 3",
            "今天不當媽媽！【博客來獨家＊附贈限量媽媽換裝紙娃娃】",
            "GEPT全民英檢初級聽力測驗初試1次過：每日刷題 10 分鐘，1 天 2 頁，1個月後高分過關！（附QR碼線上音檔）",
            "阿甘投資法：不看盤、不選股、不挑買點也能穩穩賺",
            "超預期壽命Ⅰ+Ⅱ：如何有效預防、延緩、逆轉慢性病及衰老，長壽的科學與藝術，重塑你的每一天(兩冊不分售)",
            "用JASP完成論文分析與寫作（完整版）",
            "[MUJI無印良品]半透明管自動筆/0.5mm",
            "十誡（繼續橫掃日本推理文壇，《方舟》作家最新作品，變態凶手讓全員變共犯！）",
            "圖解英文寫作使用手冊(附分類詞彙表+台大外文系學霸手寫筆記)",
            "[MUJI無印良品]透明管原子筆/0.7mm/藍",
            "納瓦爾寶典珍藏版：從白手起家到財務自由，矽谷傳奇創投家的投資哲學與人生智慧",
            "[MUJI無印良品]鋼製書架隔板.中/12x12x17.5cm",
            "我可能錯了：森林智者的最後一堂人生課",
            "[MUJI 無印良品]透明管原子筆/0.7mm/紅",
            "【鈦安TiANN】純鈦專利抗菌防沾黏 素色大砧板",
            "粉紅愛心樂團 上+下 (特裝版)",
            "擁有超常技能的異世界流浪美食家 16 (首刷限定版)",
            "段位 (電子書)",
            "山雨小學4：古古怪怪期中考",
            "火鳳燎原 79",
            "【日本楠橋紋織】KuSuPOP 三重紗 透氣純棉手巾 ‧ 灰",
            "從低谷突破：40年精神科權威史塔茲的療癒之道",
            "蛤蟆先生去看心理師（暢銷300萬冊！英國心理諮商經典，附《蛤蟆先生勇氣藏書卡》組）",
            "阿甘節稅法 (電子書)",
            "腎臟求救中：真希望40歲之前洪永祥醫師就告訴我這些事",
            "臺灣漫遊錄",
            "【統一生機】 果然優綜合堅果360g/罐",
            "抄寫英語的奇蹟：1天10分鐘，英語和人生都起飛",
            "原子習慣：細微改變帶來巨大成就的實證法則",
            "【韓國 Insan】三層萬用抗菌菜瓜布 ‧ 紅",
            "日文平假名‧片假名練習簿",
            "想被開發的理科男子 全 (首刷限定版)",
            "寧可為了戀愛哭泣 1",
            "世界盡頭的咖啡館：這一生，我為何而存在？（全球每19秒售出1本！療癒千萬人的暢銷經典，定位人生的神奇之書）",
            "想要綻放的理科男子 全",
            "社頭三姊妹【作者親簽X頭像藏書章版】",
            "Honey Trouble 2 【特裝版】",
            "世界上最透明的故事【春季限定版】：臺日出版界話題作，只有紙本書可以體驗的感動",
            "【MUJI 無印良品】桌上用面紙3入組",
            "法式甜點店的秘密法則 Frontière Française",
            "失控的焦慮世代：手機餵養的世代，如何面對心理疾病的瘟疫",
            "[MUJI 無印良品]鋁裙衣架.1段",
            "【MUJI 無印良品】微波還原除濕袋/150g",
            "心靈時刻：亞隆與22位來訪者的一期一會【博客來獨家書封版】（首刷限定：歐文亞隆印簽及給台灣讀者的一段話）",
            "【鈦安TiANN】純鈦專利抗菌防沾黏 素色大砧板2入組",
            "極限銷售：4招贏得信任，不要想著賣東西，就能締造無限商機 (電子書)",
            "Lycoris Recoil 莉可麗絲 官方漫畫精選集 Reload (3)",
            "[星巴克]波卡圓點針織背心提袋",
            "Honey Trouble 1 【特裝版】",
            "【MUJI 無印良品】(農)國產豆奶(無糖)/200ml",
            "中道【贈品限量版】：未來的靈性道路",
            "別對每件事都有反應【2025限量暢銷特典版】：淡泊一點也無妨，活出快意人生的99個禪練習！",
            "我的名字",
            "長期買進：財金教授周冠男的42堂自制力投資課 (電子書)",
            "貓福珊迪托特包 鯊魚款",
            "【MUJI無印良品】即食迷你拉麵 (韓式泡菜風味)",
            "薩古魯談業力：一個瑜伽士關於改變命運的教導",
            "【微熱山丘】 紅玉紅茶 - 6包裝",
            "鉄拳小子 愛藏版 16 (首刷限定版)",
            "【EZlife】316不鏽鋼茶水分離大容量保溫燜茶壺(1000ml) 白色",
            "只想告訴你 愛藏版 10",
            "變色龍依戀掌心 1 (首刷限定版)",
            "【日本cobono】Craze晶釉織紋 陶瓷餐碗15cm ‧ 橄欖色",
            "【日本cobono】Craze晶釉織紋 陶瓷淺盤16cm ‧ 米白色",
            "穿越驚奇圖書館4：面目全非的希臘神話（隨書附贈角色珍藏書籤）",
            "穿越驚奇圖書館3：難相處的童話大師安徒生（隨書附贈角色珍藏書籤）"
        ];
    </script>
</body>

</html>
